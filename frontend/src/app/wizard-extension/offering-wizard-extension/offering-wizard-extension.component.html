<!--
  Copyright 2024 Dataport. All rights reserved. Developed as part of the MERLOT project.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<div class="mb-3 flex-1" xmlns="http://www.w3.org/1999/html">
  <mat-stepper #stepper linear orientation="vertical">
    <mat-step>
      <ng-template matStepLabel>Define Offering Type</ng-template>
      <label class="form-label">Offering Type Selection</label>
      <select [(ngModel)]="offerType" class="form-select rounded-none w-full">
        <option value="service">Service Offering</option>
        <option selected value="data">Data Offering</option>
      </select>
      <div class="flex justify-end pt-4">
        <button (click)="prefillWizardNewOffering()" cButton color="primary" matStepperNext shape="rounded-0"
                type="submit">Next
        </button>
      </div>
    </mat-step>

    <mat-step *ngIf="isOfferingDataOffering()" [completed]="isDataResourceValid()" errorMessage="Missing fields">
      <ng-template matStepLabel>Define Data Resource</ng-template>
      <div>
        <label class="form-label">File Name*</label>
        <input [(ngModel)]="selectedFileName" class="form-control rounded-none w-full" placeholder="e.g. MyFile.json"
               type="text">
        <div cFormText style="color: #7f7f7f;">
          Please enter the file name of the file in the S3-Bucket.
        </div>
        <div *ngIf="isInvalidFileName" class="text-error pt-2">
          <small>Filename is required.</small>
        </div>
        <br/>
      </div>
      <app-base-wizard-extension #gxDataResourceWizard></app-base-wizard-extension>
      <c-accordion [flush]="true">
        <c-accordion-item #accordionItemDataOfferPolicyHints="cAccordionItem" [visible]="false">
          <ng-template cTemplateId="accordionHeaderTemplate">
              <button (click)="accordionItemDataOfferPolicyHints.toggleItem()" [collapsed]="!accordionItemDataOfferPolicyHints.visible" cAccordionButton>
                For further guidance related to “Data Resource Policy”, click here
              </button>
          </ng-template>
          <ng-template cTemplateId="accordionBodyTemplate">
            <div class="bg-brand-50 accordion-body">
              You must define machine readable policies for the data resource as expected by Gaia-x and POSSIBLE-X.
              <ul>
                <li>
                  Use under service offering “POSSIBLE-X enforced policy” to restrict booking of this data product by a consumer organisation in the POSSIBLE-X Dataspace.
                </li>
                <li>
                  The policies for data resources are not technically enforced in the POSSIBLE-X Dataspace.
                </li>
                <li>
                  A consumer organisation booking the data product shall comply to those policies.
                </li>
                <li>
                  Tip : Add those policies in human readable form under the T&Cs.
                </li>
                <li>
                  Compatible IT systems could automatically technically enforce them.
                </li>
              </ul>
              <br>
              You may define 3 types of policies: prohibitions, permissions, obligations for the data resource.
              <br><br>
              The policies related to the service providing the data resource (e.g. the use of an Eclipse Dataspace Connector) shall be defined in the next section.
              <br><br>
              For each policy type, you may take the following dimensions into account:
              <ul>
                <li>
                  <b>Access control</b>: Who is allowed to access this data resource? (e.g. only certain departments or roles)
                </li>
                <li>
                  <b>Usage control</b>: How may the data resource be used? (e.g. only for internal analyses, not to be passed on to third parties, pre-requisites to be fullfilled to use the data)
                </li>
              </ul>
              See as well IDS standard:
                <a href="https://docs.internationaldataspaces.org/ids-knowledgebase/open-dei-building-blocks-catalog/access_and_usage_control">
                  https://docs.internationaldataspaces.org/ids-knowledgebase/open-dei-building-blocks-catalog/access_and_usage_control
                </a>
              <ul>
                <li>
                  <b>Security</b>: What security precautions need to be taken? (e.g. encryption, regular security checks)
                </li>
                <li>
                  <b>Data retention</b>: How long should the data be retained and when should it be deleted? (e.g. retention for 5 years, then secure deletion)
                </li>
              </ul>
            </div>
          </ng-template>
          </c-accordion-item>
      </c-accordion>
      <div class="flex justify-between pt-4">
        <button (click)="prepareStepBeforeDataResource()" cButton color="secondary" matStepperPrevious shape="rounded-0">Back</button>
        <button (click)="prepareStepAfterDataResource()" [disabled]="!isDataResourceValid()" cButton
                color="primary"
                matStepperNext shape="rounded-0"
                type="submit">
          Next
        </button>
      </div>
    </mat-step>

    <mat-step *ngIf="isContainingPII()" [completed]="isLegitimateInterestValid()" errorMessage="Missing fields" [ngClass]="{'hidden': !isContainingPII()}">
      <ng-template matStepLabel>Define Legitimate Interest</ng-template>
      <div>
        In the previous step, it was indicated that the data contains personal identifiable information.
        It is therefore necessary to specify the legitimate interest in this additional step.
        <br/><br/>
      </div>
      <app-base-wizard-extension #gxLegitimateInterestWizard></app-base-wizard-extension>
      <div class="flex justify-between pt-4">
        <button cButton color="secondary" matStepperPrevious shape="rounded-0">Back</button>
        <button (click)="prefillServiceOfferingWizard()" [disabled]="!isLegitimateInterestValid()" cButton
                color="primary"
                matStepperNext shape="rounded-0"
                type="submit">
          Next
        </button>
      </div>
    </mat-step>

    <mat-step errorMessage="Missing fields">
      <ng-template matStepLabel>Define Service Offering</ng-template>
      <app-base-wizard-extension #gxServiceOfferingWizard></app-base-wizard-extension>
      <br/>
      <c-accordion [flush]="true">
        <c-accordion-item *ngIf="isOfferingDataOffering()" #accordionItemServiceOfferFreePolicyHints="cAccordionItem" [visible]="false">
          <ng-template cTemplateId="accordionHeaderTemplate">
            <button (click)="accordionItemServiceOfferFreePolicyHints.toggleItem()" [collapsed]="!accordionItemServiceOfferFreePolicyHints.visible" cAccordionButton>
              For further guidance related to “Service Offering Policy”, click here
            </button>
          </ng-template>
          <ng-template cTemplateId="accordionBodyTemplate">
            <div class="bg-brand-50 accordion-body">
              You must define machine readable policies for the service offering as expected by Gaia-x and POSSIBLE-X.
              <ul>
                <li>
                  Use under service offering “POSSIBLE-X enforced policy” to restrict booking of this data product by a consumer organisation in the POSSIBLE-X Dataspace.
                </li>
                <li>
                  Other policies for service offerings are not technically enforced in the POSSIBLE-X Dataspace
                </li>
                <li>
                  A consumer organisation booking the data product or service shall comply to those policies.
                </li>
                <li>
                  Tip : Add all service offering policies in human readable form under the T&Cs.
                </li>
                <li>
                  Compatible IT systems could automatically technically enforce them.
                </li>
              </ul>
              <br>
              You may define 3 types of policies: prohibitions, permissions, obligations for the service offering.
              <br><br>
              For each of them, you may take the following dimensions into account:
              <ul>
                <li>
                  <b>Access control</b>: Who is allowed to interact with the service or a specific functions? (e.g. only certain organisation, departments or roles to use a function, book the service, etc..)
                  <ul>
                    <li>
                      Please note that the policy list in the Data product / Service offer description will automatically includes the “POSSIBLE-X enforced policy”  if you select and configure it in the next section.
                    </li>
                  </ul>
                </li>
                <li>
                  <b>Terms of use / Usage control</b>: Under what conditions may the service be used? (e.g. only or not for specific purposes, if a pre-condition/a obligation is (not) met, with a defined frequency, at specific time windows etc.. )
                </li>
                <li>
                  <b>Security</b>: What security precautions need to be taken? (e.g. use of VPNs, two-factor authentication)
                </li>
                <li>
                  <b>Logging and monitoring</b>: How is the use of the service logged and monitored? (e.g. regular review of transmission logs must be done)
                </li>
                <li>
                  <b>Data integrity</b>: What obligations has the user to comply to ensure the integrity of the data input/output to/from the service? (e.g. maintain integrity proofs of data input like checksums, error correction procedures, protect data output received from the service)
                </li>
              </ul>
            </div>
          </ng-template>
        </c-accordion-item>
        <c-accordion-item *ngIf="!isOfferingDataOffering()" #accordionItemServiceOfferFreePolicyHints="cAccordionItem" [visible]="false">
          <ng-template cTemplateId="accordionHeaderTemplate">
            <button (click)="accordionItemServiceOfferFreePolicyHints.toggleItem()" [collapsed]="!accordionItemServiceOfferFreePolicyHints.visible" cAccordionButton>
              For further guidance related to “Service Offering Policy”, click here
            </button>
          </ng-template>
          <ng-template cTemplateId="accordionBodyTemplate">
            <div class="bg-brand-50 accordion-body">
              You must define machine readable policies for the service offering as expected by Gaia-x and POSSIBLE-X.
              <ul>
                <li>
                  Use under service offering “POSSIBLE-X enforced policy” to restrict booking of this service by a consumer organisation in the POSSIBLE-X Dataspace.
                </li>
                <li>
                  Other policies for service offerings are not technically enforced in the POSSIBLE-X Dataspace
                </li>
                <li>
                  A consumer organisation booking the data product or service shall comply to those policies.
                </li>
                <li>
                  Tip : Add all service offering policies in human readable form under the T&Cs.
                </li>
                <li>
                  Compatible IT systems could automatically technically enforce them.
                </li>
              </ul>
              <br>
              You may define 3 types of policies: prohibitions, permissions, obligations for the service offering.
              <br><br>
              For each of them, you may take the following dimensions into account:
              <ul>
                <li>
                  <b>Access control</b>: Who is allowed to interact with the service or a specific functions? (e.g. only certain organisation, departments or roles to use a function, book the service, etc..)
                  <ul>
                    <li>
                      Please note that the policy list in the Service offer description will automatically includes the “POSSIBLE-X enforced policy”  if you select and configure it in the next section.
                    </li>
                  </ul>
                </li>
                <li>
                  <b>Terms of use / Usage control</b>: Under what conditions may the service be used? (e.g. only or not for specific purposes, if a pre-condition/a obligation is (not) met, with a defined frequency, at specific time windows etc.. )
                </li>
                <li>
                  <b>Security</b>: What security precautions need to be taken? (e.g. use of VPNs, two-factor authentication)
                </li>
                <li>
                  <b>Logging and monitoring</b>: How is the use of the service logged and monitored? (e.g. regular review of transmission logs must be done)
                </li>
                <li>
                  <b>Data integrity</b>: What obligations has the user to comply to ensure the integrity of the data input/output to/from the service? (e.g. maintain integrity proofs of data input like checksums, error correction procedures, protect data output received from the service)
                </li>
              </ul>
            </div>
          </ng-template>
        </c-accordion-item>
      </c-accordion>
      <br/>
      <label class="form-label">POSSIBLE-X enforced policy</label>
      <div cFormText>
        Please define POSSIBLE-X enforced policies based on POSSIBLE predefined policy classes for the provided service offer. <span *ngIf="!isPolicyChecked" class="font-bold">Currently, everything is allowed.</span>
      </div>
      <c-accordion [flush]="true">
          <c-accordion-item #accordionItem="cAccordionItem" [visible]="false">
            <ng-template cTemplateId="accordionHeaderTemplate">
            <div class="accordion-header">
              <label> Restrict the contractual booking to organization(s)</label>
              <mat-checkbox (click)="accordionItem.toggleItem()" [(ngModel)]="isPolicyChecked"></mat-checkbox>
            </div>
          </ng-template>
          <ng-template cTemplateId="accordionBody">
            <div class="accordion-body">
              <div cFormText style="color: #7f7f7f;">
                Please enter organizationID
              </div>
              <div *ngFor="let id of dapsIDs; let i = index; trackBy:customTrackBy" class="flex flex-col space-y-2">
                <div class="flex items-center space-x-2">
                  <input #input="ngModel" [(ngModel)]="dapsIDs[i]" class="form-control rounded-none w-full"
                         name="dapsID{{i}}" placeholder="did:web:example-organization.eu" type="text"/>
                  <button (click)="addInput()" *ngIf="i === 0" cButton color="primary" size="sm" variant="ghost">
                    <svg cIcon class="" name="cib-addthis" size="xl"></svg>
                  </button>
                  <button (click)="removeInput(i)" *ngIf="i > 0" cButton color="primary" size="sm" variant="ghost">
                    <svg cIcon class="" name="cil-trash" size="xl"></svg>
                  </button>
                </div>
                <div *ngIf="input.touched && !isFieldFilled(dapsIDs[i])" style="color: red">
                  <small>
                    Please enter organizationID.
                  </small>
                </div>
              </div>
            </div>
          </ng-template>
        </c-accordion-item>
      </c-accordion>
      <br>
      <c-accordion [flush]="true">
        <c-accordion-item *ngIf="isOfferingDataOffering()" #accordionItemServiceOfferPossibleXPolicyHints="cAccordionItem" [visible]="false">
          <ng-template cTemplateId="accordionHeaderTemplate">
            <button (click)="accordionItemServiceOfferPossibleXPolicyHints.toggleItem()" [collapsed]="!accordionItemServiceOfferPossibleXPolicyHints.visible" cAccordionButton>
              For further guidance related to “POSSIBLE-X enforced policy”, click here
            </button>
          </ng-template>
          <ng-template cTemplateId="accordionBodyTemplate">
            <div class="bg-brand-50 accordion-body">
              You may define "POSSIBLE-X enforced policy" by configuring a predefined policy class for the use and management of this service/data product.
              <br><br>
              “Restrict the contractual booking to organization(s)” allows to restrict which organization(s) of your choice will be able to proceed with a contractual booking based on their legal participant did:web declared in the POSSIBLE-X Catalog credentials.
              <br><br>
              Please define "POSSIBLE-X enforced policy" based on POSSIBLE predefined ODRL policy classes for the provided service / data product.
              <br><br>
              Note:
              <ul>
                <li>
                  The policy will be technically enforced in the POSSIBLE-X Dataspace.
                </li>
                <li>
                  The Service Offering policy list entered above will be extended automatically with the generated “POSSIBLE-X enforced policy” upon submission if you have selected and configured it below
                </li>
              </ul>
            </div>
          </ng-template>
        </c-accordion-item>
        <c-accordion-item *ngIf="!isOfferingDataOffering()" #accordionItemServiceOfferPossibleXPolicyHints="cAccordionItem" [visible]="false">
          <ng-template cTemplateId="accordionHeaderTemplate">
            <button (click)="accordionItemServiceOfferPossibleXPolicyHints.toggleItem()" [collapsed]="!accordionItemServiceOfferPossibleXPolicyHints.visible" cAccordionButton>
              For further guidance related to “POSSIBLE-X enforced policy”, click here
            </button>
          </ng-template>
          <ng-template cTemplateId="accordionBodyTemplate">
            <div class="bg-brand-50 accordion-body">
              You may defined POSSIBLE-X enforced policy by configuring a predefined policy class for the use and management of this service.
              <br><br>
              “Restrict the contractual booking to organization(s)” allows to restrict which organization(s) of your choice will be able to proceed with a contractual booking based on their legal participant did:web declared in the POSSIBLE-X Catalog credentials.
              <br><br>
              Please define POSSIBLE-X enforced policy based on POSSIBLE predefined ODRL policy classes for the provided service.
              <br><br>
              Note:
              <ul>
                <li>
                  The policy will be technically enforced in the POSSIBLE-X Dataspace.
                </li>
                <li>
                  The Service Offering policy list entered above will be extended automatically with the generated “POSSIBLE-X enforced policy” upon submission if you have selected and configured it below
                </li>
              </ul>
            </div>
          </ng-template>
        </c-accordion-item>
      </c-accordion>
      <div class="flex justify-between pt-4">
        <button cButton color="secondary" matStepperPrevious shape="rounded-0">Back</button>
        <button (click)="createOffer()" [disabled]="!isServiceOfferingValid()" cButton color="primary" matStepperNext
                shape="rounded-0" type="submit">
          Create Offer
        </button>
      </div>
    </mat-step>

    <mat-step [editable]="false">
      <ng-template matStepLabel>Done</ng-template>
      <div class="min-h-16">
        <app-status-message
          #offerCreationStatusMessage
          [errorMessage]="'Offer creation failed.'"
          [infoMessage]="'Offer creation ongoing.'"
          [successMessage]="'Offer creation successful.'">
        </app-status-message>
      </div>
      <div class="flex justify-end pt-4">
        <button (click)="reset()" [disabled]="waitingForResponse" cButton color="primary" shape="rounded-0"
                type="submit">
          Close
        </button>
      </div>
    </mat-step>

    <!-- Icon overrides. -->
    <ng-template matStepperIcon="edit">
      <mat-icon>done</mat-icon>
    </ng-template>
  </mat-stepper>
</div>
